var treeData = {
  "name": "Forestprints",
  "type": "root",
  "children": [
    {      
      "name": "Australia",
      "type": "geolocation", 
            "children": [
        { "name": "Eucalyptus Forests",
          "children": [
        { "name": "Location",
          "children": [
        { "name": "Eastern, southern, southwestern, and northern Australia" },
          ]
        },
            
        { "name": "Main feature" ,
              "children": [
        { "name": "Dominated by Eucalyptus species, fire-adapted" },
          ]
        },
        { "name": "Soil" ,
             "children": [
        { "name": "Typically nutrient-poor, sandy/loamy; often acidic, low organic matter" },
          ]
      },
        { "name": "Economic value" ,
          "children": [
        { "name": "Forestry, essential oils (eucalyptus oil), honey production" },
          ]
         },
        { "name": "Fire ecology" ,
          "children": [
        { "name": "Many eucalypts require or benefit from fire to regenerate (epicormic buds, lignotubers, fire-triggered seed release)."}, 
          ]
         },
        { "name": "Ecological threats",
          "children": [
        { "name": "Invasive species (e.g. feral herbivores), fragmentation, changes in fire regimes, myrtle rust fungus, land clearing and logging."}, 
          ]
        },
        { "name": "Predominant Species",
         "children": [
        { "name": "Eucalyptus regnans (Mountain Ash) "},
           { "name": "Eucalyptus globulus (Blue Gum) "},
           { "name": "Eucalyptus marginata (Jarrah)"},
           { "name": "Eucalyptus camaldulensis (River Red Gum)"}
          ]
        },
        { "name": "Endangered Species",
        "children": [
        { "name": "Eucalyptus conglomerata (Swamp Stringybark – threatened tree species)"},
          { "name": "Leadbeater’s Possum (Gymnobelideus leadbeateri)"},
          { "name": "Greater Glider (Petauroides volans)"},
          { "name": "Swift Parrot (Lathamus discolor)"}
                ]
            },
            ]
         },
        { "name": "Tropical Rainforests (Daintree)",
         "children": [
        { "name": "Location",
          "children": [
        { "name": "Far North Queensland, primarily the Daintree Rainforest (part of the Wet Tropics World Heritage Area)" },
          ]
        },
            
        { "name": "Main feature" ,
              "children": [
        { "name": "Dominated by: Broadleaf evergreen trees, vines, ferns, palms" },
          ]
        },
        { "name": "Soil" ,
             "children": [
        { "name": "Highly weathered tropical red and yellow earths, generally nutrient-poor, due to intense leaching" },
          ]
      },
        { "name": "Economic value" ,
          "children": [
        { "name": "Ecotourism, bushfoods" },
          ]
         },
        { "name": "Fire ecology" ,
          "children": [
        { "name": "Fire-sensitive; unlike eucalyptus forests, fires can cause severe damage."}, 
          ]
         },
        { "name": "Ecological threats",
          "children": [
        { "name": "Climate change, invasive species (e.g. feral pigs, weeds), habitat fragmentation, tourism pressure, and cyclones"}, 
          ]
        },
        { "name": "Predominant Species",
         "children": [
        { "name": "Fan Palm (Licuala ramsayi)"},
           { "name": "Southern Silky Oak (Grevillea robusta)"},
           { "name": "Wait-a-while (Calamus australis, a climbing palm)"},
           { "name": "Idiospermum australiense (Ribbonwood) – a primitive flowering plant"}
          ]
        },
        { "name": "Endangered Species",
        "children": [
        { "name": "Southern Cassowary (Casuarius casuarius johnsonii)"},
          { "name": "Spotted-tailed Quoll (Dasyurus maculatus)"},
          { "name": "Macleay's Fig-Parrot (Cyclopsitta diophthalma macleayana)"},
          { "name": "Cooper Creek Haplostichanthus (Haplostichanthus sp.) – rare tree"}
                ]
            },
            ]
        },
        { "name": "Temperate Rainforests (Tasmania)",
         "children": [
        { "name": "Location",
          "children": [
        { "name": "Western Tasmania, including the Tarkine, Franklin-Gordon, and Southwest regions" },
          ]
        },
            
        { "name": "Main feature" ,
              "children": [
        { "name": "Dominated by: Ancient Gondwanan species – broadleaf evergreens, conifers, mosses" },
          ]
        },
        { "name": "Soil" ,
             "children": [
        { "name": "Acidic, leached soils, often derived from quartzite or dolerite, low in nutrients, high in organic matter (peaty in some areas)" },
          ]
      },
        { "name": "Economic value" ,
          "children": [
        { "name": "Ecotourism, timber, bushfoods" },
          ]
         },
        { "name": "Fire ecology" ,
          "children": [
        { "name": "Extremely fire-sensitive – fire can permanently destroy rainforest ecosystems"}, 
          ]
         },
        { "name": "Ecological threats",
          "children": [
        { "name": "Logging (especially historical clearfelling), invasive species (e.g. Phytophthora root rot, feral species), climate change and drying trends, increasing fire risk"}, 
          ]
        },
        { "name": "Predominant Species",
         "children": [
        { "name": "Nothofagus cunninghamii (Myrtle Beech)"},
           { "name": "Atherosperma moschatum (Southern Sassafras)"},
           { "name": "Phyllocladus aspleniifolius (Celery-top Pine)"},
           { "name": "Athrotaxis selaginoides (King Billy Pine – endemic conifer)"}
          ]
        },
        { "name": "Endangered Species",
        "children": [
        { "name": "Tasmanian Wedge-tailed Eagle (Aquila audax fleayi)"},
          { "name": "Tasmanian Devil (Sarcophilus harrisii)"},
          { "name": "Huon Pine (Lagarostrobos franklinii) – extremely slow-growing"},
          { "name": "Orange-bellied Parrot (Neophema chrysogaster)"}
                ]
            },
            ]
        },
        { "name": "Mulga & Acacia Woodlands",
          "children": [
        { "name": "Location",
          "children": [
        { "name": "Arid and semi-arid interior – Western Australia, South Australia, Queensland, NT, NSW" },
          ]
        },
            
        { "name": "Main feature" ,
              "children": [
        { "name": "Dominated by: Acacia aneura (Mulga) and related acacia species" },
          ]
        },
        { "name": "Soil" ,
             "children": [
        { "name": "Red sandy or loamy soils, often with ironstone or calcrete, low fertility, highly erodible, susceptible to salinisation and compaction" },
          ]
      },
        { "name": "Economic value" ,
          "children": [
        { "name": "Pastoral grazing (especially cattle and sheep), honey production (from flowering acacias), charcoal and firewood (low-scale use, often unsustainable), bushfoods and medicine, mining (significant overlap with mineral-rich areas – iron ore, uranium)" },
          ]
         },
        { "name": "Fire ecology" ,
          "children": [
        { "name": "Naturally fire-sensitive, but regenerates from seed banks, too frequent fires degrade ecosystem permanently"}, 
          ]
         },
        { "name": "Ecological threats",
          "children": [
        { "name": "Overgrazing, invasive species (feral camels, cats, rabbits), land clearing for agriculture and mining, groundwater depletion, desertification trends"}, 
          ]
        },
        { "name": "Predominant Species",
         "children": [
        { "name": "Acacia aneura (Mulga)"},
           { "name": "Acacia kempeana (Witchetty Bush)"},
           { "name": "Eremophila spp. (Emu Bushes)"},
           { "name": "Spinifex grasses (Triodia spp.)"}
          ]
        },
        { "name": "Endangered Species",
        "children": [
        { "name": "Night Parrot (Pezoporus occidentalis)"},
          { "name": "Greater Bilby (Macrotis lagotis)"},
          { "name": "Mulgara (Dasycercus cristicauda)"},
          { "name": "Acacia pickardii (rare Mulga species)"}
                ]
            },
            ]
        }
            
                 ]
    },
              
    {      "name": "Southeast Asia & Oceania",
     "type": "geolocation", 
            "children": [
        { "name": "Dipterocarp Forests (Borneo, Sumatra)",
         "children": [
        { "name": "Location",
          "children": [
        { "name": "Lowland and hill forests of Borneo, Sumatra, Peninsular Malaysia, parts of the Philippines" },
          ]
        },
            
        { "name": "Main feature" ,
              "children": [
        { "name": "Dominated by tall dipterocarp tree species, forming emergent layers up to 70 meters" },
          ]
        },
        { "name": "Soil" ,
             "children": [
        { "name": "Weathered, acidic, nutrient-poor tropical soils, often ultisols or oxisols; richer in alluvial plains and hill slopes" },
          ]
      },
        { "name": "Economic value" ,
          "children": [
        { "name": "Timber extraction, aromatic resins (camphor, damar), oil palm conversion, ecotourism in protected sites" },
          ]
         },
        { "name": "Fire ecology" ,
          "children": [
        { "name": "Naturally fire-resistant when intact; highly flammable post-logging or drainage"}, 
          ]
         },
        { "name": "Ecological threats",
          "children": [
        { "name": "Logging (legal and illegal), deforestation for plantations, fragmentation, peat fires, poaching, and climate change"}, 
          ]
        },
        { "name": "Predominant Species",
         "children": [
        { "name": "Shorea leprosula"},
           { "name": "Dipterocarpus grandiflorus"},
           { "name": "Dryobalanops aromatica (camphor tree)"},
           { "name": "Hopea odorata"}
          ]
        },
        { "name": "Endangered Species",
        "children": [
        { "name": "Pongo pygmaeus (Bornean Orangutan)"},
          { "name": "Panthera tigris jacksoni (Malayan Tiger)"},
          { "name": "Manis javanica (Sunda Pangolin)"},
          { "name": "Rafflesia arnoldii (world’s largest flower)"},
          { "name": "Shorea lumutensis (critically endangered dipterocarp)"}
                ]
            },
            ]
        },
        { "name": "Peat Swamp Forests (Indonesia, Malaysia)",
         "children": [
        { "name": "Location",
          "children": [
        { "name": "Low-lying inland and coastal zones of Sumatra, Borneo, and Peninsular Malaysia" },
          ]
        },
            
        { "name": "Main feature" ,
              "children": [
        { "name": "Dominated by water-tolerant trees adapted to low-oxygen, acidic peat soils" },
          ]
        },
        { "name": "Soil" ,
             "children": [
        { "name": "Deep peat layers (up to 20m), acidic, waterlogged, extremely low in nutrients; formed from centuries of accumulated plant material" },
          ]
      },
        { "name": "Economic value" ,
          "children": [
        { "name": "Timber (ramin, meranti), illegal logging, conversion to oil palm and pulpwood plantations" },
          ]
         },
        { "name": "Fire ecology" ,
          "children": [
        { "name": "Extremely fire-prone when drained; peat fires smolder underground and release massive carbon stores"}, 
          ]
         },
        { "name": "Ecological threats",
          "children": [
        { "name": "Drainage canals, fire, illegal logging, peat oxidation, conversion to monoculture plantations, biodiversity loss, haze pollution"}, 
          ]
        },
        { "name": "Predominant Species",
         "children": [
        { "name": "Shorea albida"},
           { "name": "Gonystylus bancanus (Ramin)"},
           { "name": "Stenochlaena palustris (Climbing Fern)"},
           { "name": "Combretocarpus rotundatus"}
          ]
        },
        { "name": "Endangered Species",
        "children": [
        { "name": "Pongo abelii (Sumatran Orangutan)"},
          { "name": "Nasalis larvatus (Proboscis Monkey)"},
          { "name": "Nephrolepis biserrata (sensitive fern species)"},
          { "name": "Gonystylus bancanus (highly threatened due to overharvesting)"}
                        ]
            },
            ]
        },
        { "name": "Mangrove Forests (Indonesia, Philippines, Papua New Guinea)",
           "children": [
        { "name": "Location",
          "children": [
        { "name": "Coastal intertidal zones, river deltas, estuaries, and lagoons throughout Southeast Asia and Oceania" },
          ]
        },
            
        { "name": "Main feature" ,
              "children": [
        { "name": "Salt-tolerant trees and shrubs adapted to tidal zones and brackish waters" },
          ]
        },
        { "name": "Soil" ,
             "children": [
        { "name": "Waterlogged, anaerobic, high in organic matter and salinity; mud or silty clay sediments" },
          ]
      },
        { "name": "Economic value" ,
          "children": [
        { "name": " Coastal fisheries, timber and charcoal (limited), honey, tannins, eco- and blue carbon tourism, shoreline protection services" },
          ]
         },
        { "name": "Fire ecology" ,
          "children": [
        { "name": "Not fire-adapted; typically not exposed to fire due to wet conditions"}, 
          ]
         },
        { "name": "Ecological threats",
          "children": [
        { "name": "Coastal development, aquaculture (esp. shrimp farms), pollution, sea level rise, sediment disruption, overharvesting"}, 
          ]
        },
        { "name": "Predominant Species",
         "children": [
        { "name": "Rhizophora mucronata"},
           { "name": "Avicennia marina"},
           { "name": "Bruguiera gymnorrhiza"},
           { "name": "Nypa fruticans (Nipa palm)"}
          ]
        },
        { "name": "Endangered Species",
        "children": [
        { "name": "Dugong dugon (Dugong)"},
          { "name": "Chelonia mydas (Green Sea Turtle)"},
          { "name": "Acanthaster planci (Crown-of-Thorns Starfish – reef impact)"},
          { "name": "Sonneratia griffithii (critically endangered mangrove tree)"}
                        ]
            },
            ]
        },
                        ]
    },
   {      "name": "East Asia",
     "type": "geolocation", 
            "children": [
        { "name": "Temperate Deciduous Forests (China, Japan, Korea)",
          "children": [
        { "name": "Location",
          "children": [
        { "name": "Low to mid-elevation zones in eastern China, the Korean Peninsula, and southern-central Japan (e.g. Honshu, Shikoku)" },
          ]
        },
            
        { "name": "Main feature" ,
              "children": [
        { "name": "Broadleaf deciduous trees with seasonal leaf loss" },
          ]
        },
        { "name": "Soil" ,
             "children": [
        { "name": "Brown forest soils; moderately fertile, loamy, rich in organic matter; prone to erosion when cleared" },
          ]
      },
        { "name": "Economic value" ,
          "children": [
        { "name": "Timber production, mushroom harvesting (e.g. shiitake, matsutake), fall tourism (foliage season), medicinal plant trade" },
          ]
         },
        { "name": "Fire ecology" ,
          "children": [
        { "name": "Generally low fire frequency; forests are not fire-adapted and may degrade with increased burning"}, 
          ]
         },
        { "name": "Ecological threats",
          "children": [
        { "name": "Deforestation, urban sprawl, invasive species, air pollution (acid rain), fragmentation from roads and agriculture"}, 
          ]
        },
        { "name": "Predominant Species",
         "children": [
        { "name": "Quercus mongolica (Mongolian Oak)"},
           { "name": "Acer palmatum (Japanese Maple)"},
           { "name": "Fagus crenata (Japanese Beech)"},
           { "name": "Zelkova serrata"}
          ]
        },
        { "name": "Endangered Species",
        "children": [
        { "name": "Panthera pardus orientalis (Amur Leopard)"},
          { "name": "Bubo blakistoni (Blakiston’s Fish Owl)"},
          { "name": "Prunus takesimensis (rare wild cherry)"},
          { "name": "Elaeocarpus japonicus (regionally threatened tree)"}
                          ]
            },
            ]
        },
        { "name": "Subtropical Evergreen Forests (China, Taiwan)",
         "children": [
        { "name": "Location",
          "children": [
        { "name": "Southeastern China, Taiwan, low to mid elevations" },
          ]
        },
            
        { "name": "Main feature" ,
              "children": [
        { "name": "Broadleaf evergreen species, moisture-loving, dense canopy" },
          ]
        },
        { "name": "Soil" ,
             "children": [
        { "name": "Acidic, well-drained, rich in organic matter, lateritic and red soils common" },
          ]
      },
        { "name": "Economic value" ,
          "children": [
        { "name": "Timber, tea plantations nearby, medicinal plants" },
          ]
         },
        { "name": "Fire ecology" ,
          "children": [
        { "name": " Low fire frequency, fire-sensitive species, canopy rarely affected by fire, natural regeneration relies on seed dispersal rather than resprouting."}, 
          ]
         },
        { "name": "Ecological threats",
          "children": [
        { "name": "Deforestation for agriculture and urban expansion, invasive species, habitat fragmentation, soil erosion"}, 
          ]
        },
        { "name": "Predominant Species",
         "children": [
        { "name": "Castanopsis chinensis (Chinese Chestnut)"},
           { "name": "Lithocarpus spp. (Stone Oaks)"},
           { "name": "Schima superba (Chinese Evergreen Oak)"},
           { "name": "Cinnamomum camphora (Camphor tree)"},
           { "name": "Machilus spp."}
          ]
        },
        { "name": "Endangered Species",
        "children": [
        { "name": "South China Tiger (Panthera tigris amoyensis)"},
          { "name": "Formosan Black Bear (Ursus thibetanus formosanus)"},
          { "name": "Chinese Giant Salamander (Andrias davidianus)"},
          { "name": "Camellia spp. (rare/endemic)"}
                    ]
            },
            ]
        },
                        ]
    },
      {      "name": "Central & South Asia",
     "type": "geolocation", 
            "children": [
        { "name": "Himalayan Coniferous Forests (Nepal, Bhutan, India)"},
        { "name": "Tropical Dry Forests (India, Sri Lanka)"},
                               ]
    },
    {      "name": "Middle East & North Africa",
     "type": "geolocation", 
            "children": [
        { "name": "Mediterranean Forests (Lebanon, Turkey, Morocco)"},
        { "name": "Saharan Oases Forests (Egypt, Algeria)"}
      ]   
     },
     {      "name": "Sub-Saharan Africa",
     "type": "geolocation", 
            "children": [
        { "name": "Congo Rainforest (DRC, Gabon, Cameroon)"},
        { "name": "Miombo Woodlands (Zambia, Tanzania, Mozambique)"}
      ] 
       },
     {      "name": "North America",
     "type": "geolocation", 
            "children": [
        { "name": "Pacific Temperate Rainforests (Canada, USA)"},
        { "name": "Eastern Deciduous Forests (USA, Canada)"},
        { "name": "Boreal Forests (Canada, Alaska)"}
      ] 
        },
     {      "name": "Central & South America",
     "type": "geolocation", 
            "children": [
        { "name": "Amazon Rainforest (Brazil, Peru, Colombia)"},
        { "name": "Atlantic Forest (Brazil, Paraguay, Argentina)"},
        { "name": "Andean Cloud Forests (Ecuador, Colombia, Peru)"}
      ] 
      }
    ] 
};

// Set the dimensions and margins of the diagram
var margin = {top: 40, right: 120, bottom: 40, left: 120},
    width = 1200 - margin.left - margin.right,
    height = 800 - margin.top - margin.bottom;

// append the svg object to the tree container
var svg = d3.select("#tree-container").append("svg")
    .attr("width", width + margin.right + margin.left)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var i = 0,
    duration = 750,
    root;

// declares a tree layout and assigns the size
var treemap = d3.tree().size([height, width]);

// Assigns parent, children, height, depth
root = d3.hierarchy(treeData, function(d) { return d.children; });
root.x0 = height / 2;
root.y0 = 0;

// Collapse after the first level (show only main ecosystems initially)
if (root.children) {
  root.children.forEach(collapse);
}

update(root);

// Collapse the node and all its children
function collapse(d) {
  if(d.children) {
    d._children = d.children;
    d._children.forEach(collapse);
    d.children = null;
  }
}

function update(source) {
  // Assigns the x and y position for the nodes
  var treeData = treemap(root);

  // Compute the new tree layout.
  var nodes = treeData.descendants(),
      links = treeData.descendants().slice(1);

  // Normalize for fixed-depth.
  nodes.forEach(function(d){ d.y = d.depth * 200});

  // ****************** Nodes section ***************************

  // Update the nodes...
  var node = svg.selectAll('g.node')
      .data(nodes, function(d) {return d.id || (d.id = ++i); });

  // Enter any new modes at the parent's previous position.
  var nodeEnter = node.enter().append('g')
      .attr('class', 'node')
      .attr("transform", function(d) {
        return "translate(" + source.y0 + "," + source.x0 + ")";
      })
      .on('click', click);

  // Add Circle for the nodes
  nodeEnter.append('circle')
      .attr('class', 'node')
      .attr('r', 1e-6)
      .style("fill", "#023ad9");

  // Add labels for the nodes
  nodeEnter.append('text')
      .attr("dy", ".35em")
      .attr("x", function(d) {
        return d.children || d._children ? -15 : 15;
      })
      .attr("text-anchor", function(d) {
        return d.children || d._children ? "end" : "start";
      })
      .attr("class", function(d) {
        if (d.data.type === "root") return "main-title";
        if (d.data.type === "ecosystem") return "ecosystem-title";
        return "detail-text";
      })
      .text(function(d) { return d.data.name; })
.each(function(d) {
  if (d.children || d._children) {
    d3.select(this).call(wrap, 200); // Apply wrap only if node has children
  }
});

  // UPDATE
  var nodeUpdate = nodeEnter.merge(node);

  // Transition to the proper position for the node
  nodeUpdate.transition()
    .duration(duration)
    .attr("transform", function(d) {
        return "translate(" + d.y + "," + d.x + ")";
     });

  // Update the node attributes and style
  nodeUpdate.select('circle.node')
    .attr('r', function(d) {
      if (d.data.type === "root") return 8;
      if (d.data.type === "ecosystem") return 6;
      return 4;
    })
    .style("fill", "#023ad9")
    .attr('cursor', 'pointer');

  // Remove any exiting nodes
  var nodeExit = node.exit().transition()
      .duration(duration)
      .attr("transform", function(d) {
          return "translate(" + source.y + "," + source.x + ")";
      })
      .remove();

  // On exit reduce the node circles size to 0
  nodeExit.select('circle')
    .attr('r', 1e-6);

  // On exit reduce the opacity of text labels
  nodeExit.select('text')
    .style('fill-opacity', 1e-6);

  // ****************** links section ***************************

  // Update the links...
  var link = svg.selectAll('path.link')
      .data(links, function(d) { return d.id; });

  // Enter any new links at the parent's previous position.
  var linkEnter = link.enter().insert('path', "g")
      .attr("class", "link")
      .attr('d', function(d){
        var o = {x: source.x0, y: source.y0};
        return diagonal(o, o);
      });

  // UPDATE
  var linkUpdate = linkEnter.merge(link);

  // Transition back to the parent element position
  linkUpdate.transition()
      .duration(duration)
      .attr('d', function(d){ return diagonal(d, d.parent) });

  // Remove any exiting links
  var linkExit = link.exit().transition()
      .duration(duration)
      .attr('d', function(d) {
        var o = {x: source.x, y: source.y};
        return diagonal(o, o);
      })
      .remove();

  // Store the old positions for transition.
  nodes.forEach(function(d){
    d.x0 = d.x;
    d.y0 = d.y;
  });

  // Creates a curved (diagonal) path from parent to the child nodes
  function diagonal(s, d) {
    path = `M ${s.y} ${s.x}
            C ${(s.y + d.y) / 2} ${s.x},
              ${(s.y + d.y) / 2} ${d.x},
              ${d.y} ${d.x}`;
    return path;
  }

  // Toggle children on click.
  function click(d) {
    if (d.children) {
        d._children = d.children;
        d.children = null;
      } else {
        d.children = d._children;
        d._children = null;
    }
    update(d);
  }
}

// Function to wrap text
function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", text.attr("x")).attr("y", y).attr("dy", dy + "em");
    
    while (word = words.pop()) {
      line.push(word);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
        tspan.text(line.join(" "));
        line = [word];
        tspan = text.append("tspan").attr("x", text.attr("x")).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
      }
    }
  });
}